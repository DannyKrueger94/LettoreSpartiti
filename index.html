<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lettore Spartiti - Auto Scroll</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags per PWA -->
    <meta name="description" content="App per leggere spartiti PDF mentre suoni la chitarra, con auto-scroll a velocitÃ  variabile">
    <meta name="theme-color" content="#16213e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SpartitiApp">
    
    <!-- Icone Apple -->
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512x512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- HEADER: Titolo o Controlli -->
    <header>
        <h1 id="headerTitle">Lettura Spartiti</h1>
        <div id="controls" class="header-controls" style="display: none;">
            <button id="playPauseBtn" class="btn-control btn-play-pause btn-round" title="Play / Pausa">
                <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </button>
            <div class="speed-control">
                <label for="speedSlider">VelocitÃ </label>
                <input type="range" id="speedSlider" min="0.1" max="1.5" value="0.5" step="0.1">
                <span id="speedValue">x0.5</span>
            </div>
            <button id="resetBtn" class="btn-control btn-round" title="Torna all'inizio">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                </svg>
            </button>
            <button id="toggleNotesBtn" class="btn-control btn-round" title="Mostra/Nascondi Note">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                </svg>
            </button>
            <button id="videoBtn" class="btn-control btn-round" title="Apri Video Tutorial" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
            </button>
            <button id="changeFileBtn" class="btn-control btn-round" title="Torna al menu">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
            </button>
            <button id="fullscreenBtn" class="btn-control btn-round" title="Schermo intero">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- MAIN CONTAINER: Area principale dove visualizzeremo lo spartito -->
    <main>
        <!-- Sezione di caricamento file -->
        <div id="uploadSection" class="upload-section">
            <!-- Libreria spartiti precaricati -->
            <div class="library-section">
                <div class="library-header">
                    <h2 class="library-title">La mia libreria</h2>
                    <button id="syncBtn" class="btn-sync" title="Scarica tutti gli spartiti per uso offline">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        <span>Sincronizza spartiti</span>
                        <span id="syncBadge" class="sync-badge" style="display: none;">!</span>
                    </button>
                </div>
                
                <!-- Barra progresso sincronizzazione -->
                <div id="syncProgress" class="sync-progress" style="display: none;">
                    <div class="sync-progress-bar">
                        <div id="syncProgressBar" class="sync-progress-fill"></div>
                    </div>
                    <div id="syncProgressText" class="sync-progress-text">0/0</div>
                </div>
                
                <div id="libraryContainer" class="library-grid">
                    <!-- Popolato dinamicamente da spartiti-library.js -->
                </div>
            </div>
        </div>

        <!-- Contenitore per visualizzare il PDF (inizialmente nascosto) -->
        <div id="pdfContainer" class="pdf-container" style="display: none;">
            <!-- Pannello NOTE (fisso a sinistra) -->
            <div id="notesPanel" class="notes-panel">
                <canvas id="notesCanvas"></canvas>
            </div>
            
            <!-- Pannello SPARTITO (scrollabile a destra) -->
            <div id="sheetPanel" class="sheet-panel">
                <canvas id="pdfCanvas"></canvas>
            </div>
        </div>
    </main>



    <!-- Includiamo PDF.js dalla CDN (libreria Mozilla per leggere PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- I nostri script JavaScript -->
    <script src="js/dbManager.js"></script>
    <script src="js/pdfHandler.js"></script>
    <script src="js/spartiti-library.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Registra il Service Worker per funzionamento offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker registrato con successo:', registration.scope);
                        
                        // FORZA aggiornamento immediato se c'Ã¨ una nuova versione
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('ðŸ”„ Nuova versione Service Worker trovata!');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nuova versione disponibile - AGGIORNA AUTOMATICAMENTE
                                    console.log('ðŸ”„ Attivazione nuova versione...');
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    
                                    // Ricarica pagina dopo 500ms per applicare aggiornamenti
                                    setTimeout(() => {
                                        console.log('â™»ï¸ Ricaricamento per applicare aggiornamenti...');
                                        window.location.reload();
                                    }, 500);
                                }
                            });
                        });
                        
                        // Controlla aggiornamenti ogni 10 secondi (piÃ¹ frequente)
                        setInterval(() => {
                            registration.update();
                        }, 10000);
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('âŒ Registrazione Service Worker fallita:', error);
                    });
            });
        }
        
        // Gestione prompt "Aggiungi alla schermata Home"
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Previeni il prompt automatico
            e.preventDefault();
            deferredPrompt = e;
            
            console.log('ðŸ’¡ App puÃ² essere installata!');
            
            // Mostra un pulsante personalizzato per installare (opzionale)
            // Puoi aggiungere un bottone nell'UI in futuro
            
            // Per ora, mostra automaticamente dopo 3 secondi
            setTimeout(() => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('âœ… Utente ha accettato l\'installazione');
                        } else {
                            console.log('âŒ Utente ha rifiutato l\'installazione');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 3000);
        });
        
        // Gestione installazione completata
        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA installata con successo!');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
